generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String               @id
  email       String               @unique
  fullName    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  role        String?
  disabled    Boolean              @default(false)
  lastLogin   DateTime?
  memberships OrganizationMember[]
}

model OrganizationMember {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  role           String
  status         String       @default("pending")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

model Organization {
  id         String               @id @default(uuid())
  name       String
  domains    String[]
  ownerEmail String?
  status     String               @default("pending")
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  logs       Log[]
  members    OrganizationMember[]
  domainWafStatuses DomainWAFStatus[]
}

model Log {
  id             String        @id @default(uuid())
  organizationId String?
  action         String
  severity       String
  timestamp      DateTime
  clientIp       String
  clientPort     Int?
  host           String
  method         String
  requestUrl     String
  rule           String?
  ruleId         String?
  userAgent      String?
  headers        Json?
  message        String?
  httpMethod     String?
  responseHeader Json?
  responseCode   Int?
  maturity       Int?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([timestamp])
  @@index([clientIp])
  @@index([action])
  @@index([severity])
}

model DomainWAFStatus {
  id             String       @id @default(uuid())
  organizationId String
  domain         String
  wafEnabled     Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
}

model ModsecLanding {
  id        BigInt   @id @default(autoincrement()) @map("id")
  tag       String?  @map("tag")
  time      DateTime @default(now()) @map("time") @db.Timestamp(6)
  data      Json     @map("data")
  processed Boolean? @default(false) @map("processed")

  @@map("modsec_landing")
  @@index([processed])
  @@index([time])
  @@index([tag])
}
